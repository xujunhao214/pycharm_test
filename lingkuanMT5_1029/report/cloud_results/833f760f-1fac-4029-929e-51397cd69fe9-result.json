{"name": "出现漏平-redis数据和数据库的数据做比对", "status": "failed", "statusDetails": {"message": "AssertionError: Failed: 数据列表不匹配（字段 size 精度不匹配）", "trace": "self = <lingkuanMT5_1029.test_cloudTrader.test_cloudOrder_open_level.TestMT5cloudTrader_openandlevel.TestMT5cloudTrader_level object at 0x0000015CAAACF880>\nclass_random_str = '9dn79548'\nvar_manager = <lingkuanMT5_1029.commons.variable_manager.VariableManager object at 0x0000015CAAAF97C0>\ndb_transaction = <pymysql.connections.Connection object at 0x0000015CAAA21D60>\nredis_MT5cloudTrader_data_close = [{'lots': 0.0, 'magic': 19577, 'openPrice': 4018.67, 'symbol': 'XAUUSDp', ...}]\n\n    @allure.title(\"出现漏平-redis数据和数据库的数据做比对\")\n    def test_dbquery_redis(self, class_random_str, var_manager, db_transaction, redis_MT5cloudTrader_data_close):\n        with allure.step(\"1. 获取订单详情表账号数据\"):\n            MT5cloudTrader_user_accounts_2 = var_manager.get_variable(\"MT5cloudTrader_user_accounts_2\")\n            cloudOrderSend = var_manager.get_variable(\"cloudOrderSend\")\n            symbol = cloudOrderSend[\"symbol\"]\n    \n            sql = f\"\"\"\n                      SELECT *\n                      FROM follow_order_detail\n                      WHERE symbol LIKE %s\n                        AND account = %s\n                        AND comment = %s\n                      \"\"\"\n            params = (\n                f\"%{symbol}%\",\n                MT5cloudTrader_user_accounts_2,\n                class_random_str\n            )\n    \n            # 调用轮询等待方法（带时间范围过滤）\n            db_data = self.query_database_with_time(\n                db_transaction=db_transaction,\n                sql=sql,\n                params=params,\n                time_field=\"create_time\"\n            )\n    \n        with allure.step(\"2. 转换Redis数据为可比较格式\"):\n            if not redis_MT5cloudTrader_data_close:\n                pytest.fail(\"Redis中未查询到订单数据\")\n    \n            # 转换Redis数据为与数据库一致的格式\n            MT5cloudTrader_redis_comparable_levellist = convert_redis_orders_to_comparable_list(\n                redis_MT5cloudTrader_data_close)\n            logging.info(f\"转换后的Redis数据: {MT5cloudTrader_redis_comparable_levellist}\")\n    \n            # 将转换后的数据存入变量管理器\n            var_manager.set_runtime_variable(\"MT5cloudTrader_redis_comparable_levellist\",\n                                             MT5cloudTrader_redis_comparable_levellist)\n    \n        with allure.step(\"3. 比较Redis与数据库数据\"):\n            # 假设db_data是之前从数据库查询的结果\n            if not db_data:\n                pytest.fail(\"数据库中未查询到订单数据\")\n    \n            # 提取数据库中的关键字段（根据实际数据库表结构调整）\n            db_comparable_list = [\n                {\n                    \"order_no\": record[\"order_no\"],  # 数据库order_no → 统一字段order_no\n                    \"magical\": record[\"magical\"],  # 数据库magical → 统一字段magical\n                    \"size\": float(record[\"size\"]),  # 数据库size → 统一字段size\n                    \"open_price\": float(record[\"open_price\"]),\n                    \"symbol\": record[\"symbol\"]\n                }\n                for record in db_data\n            ]\n            logging.info(f\"数据库转换后: {db_comparable_list}\")\n            # 比较两个列表（可根据需要调整比较逻辑）\n>           self.assert_data_lists_equal(\n                actual=MT5cloudTrader_redis_comparable_levellist,\n                expected=db_comparable_list,\n                fields_to_compare=[\"order_no\", \"magical\", \"size\", \"open_price\", \"symbol\"],\n                tolerance=1e-6\n            )\n\ntest_cloudTrader\\test_cloudOrder_open_level.py:889: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\ncommons\\api_base.py:1312: in assert_data_lists_equal\n    raise e\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nself = <lingkuanMT5_1029.test_cloudTrader.test_cloudOrder_open_level.TestMT5cloudTrader_openandlevel.TestMT5cloudTrader_level object at 0x0000015CAAACF880>\nactual = [{'magical': 19577, 'open_price': 4018.67, 'order_no': 2387575, 'size': 0.0, ...}]\nexpected = [{'magical': 19577, 'open_price': 4018.67, 'order_no': 2387575, 'size': 1.0, ...}]\nfields_to_compare = ['order_no', 'magical', 'size', 'open_price', 'symbol']\ntolerance = 1e-06, error_msg_prefix = '数据列表不匹配'\n\n    def assert_data_lists_equal(self, actual, expected, fields_to_compare, tolerance=1e-9,\n                                error_msg_prefix=\"数据列表不匹配\"):\n        \"\"\"断言两个数据列表的指定字段相等（带Allure分层提示）\"\"\"\n        actual_sorted = sorted(actual, key=lambda x: x[\"order_no\"])\n        expected_sorted = sorted(expected, key=lambda x: x[\"order_no\"])\n    \n        with allure.step(\"断言数据列表相等\"):\n            allure.attach(f\"比较字段: {fields_to_compare}\", \"比较维度\", allure.attachment_type.TEXT)\n            allure.attach(f\"浮点数容差: {tolerance}\", \"精度设置\", allure.attachment_type.TEXT)\n            allure.attach(self.serialize_data(actual_sorted), \"实际列表\", allure.attachment_type.JSON)\n            allure.attach(self.serialize_data(expected_sorted), \"预期列表\", allure.attachment_type.JSON)\n    \n        try:\n            assert len(actual_sorted) == len(expected_sorted), \\\n                f\"Failed: {error_msg_prefix}（长度不匹配）\"\n    \n            for a, e in zip(actual_sorted, expected_sorted):\n                for field in fields_to_compare:\n                    actual_val = a[field]\n                    expected_val = e[field]\n    \n                    if isinstance(actual_val, float) and isinstance(expected_val, float):\n>                       assert abs(actual_val - expected_val) <= tolerance, \\\n                            f\"Failed: {error_msg_prefix}（字段 {field} 精度不匹配）\"\nE                           AssertionError: Failed: 数据列表不匹配（字段 size 精度不匹配）\n\ncommons\\api_base.py:1304: AssertionError"}, "description": "\n    ### 用例说明\n    - 前置条件：有云策略和云跟单\n    - 操作步骤：\n      1. 修改云跟单账号平仓-关闭\n      2. 进行开仓\n      3. 进行平仓\n      4. 跟单账号平仓失败，有漏单数据，把redis数据和MySQL数据进行校验\n      5. 修改云跟单账号平仓-开启\n    - 预期结果：云跟单账号平仓-关闭，有漏单数据\n    ", "steps": [{"name": "1. 获取订单详情表账号数据", "status": "passed", "steps": [{"name": "轮询等待数据稳定（超时: 30秒，稳定期: 2秒）", "status": "passed", "steps": [{"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "attachments": [{"name": "执行SQL", "source": "52e5ce6a-c0a3-4089-b46c-ff53d78df925-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "b812bcb1-0476-4ecb-952e-fec8a650e140-attachment.txt", "type": "text/plain"}], "start": 1761729623786, "stop": 1761729623841}], "attachments": [{"name": "查询条件", "source": "cc4d22e1-184a-4d9e-ba52-f4f1cc32154d-attachment.txt", "type": "text/plain"}], "start": 1761729623786, "stop": 1761729623841}, {"name": "轮询中（已等待0.1秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "826ba281-8ab8-4838-84a0-1733fefaa51d-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "cd28de38-60f5-4967-a7d0-53f1f2f89016-attachment.txt", "type": "text/plain"}], "start": 1761729623841, "stop": 1761729623841}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "判断结果", "source": "d4d88ea0-4fef-4d9d-baee-695b50f2ca64-attachment.txt", "type": "text/plain"}], "start": 1761729623841, "stop": 1761729623842}, {"name": "数据发生变化", "status": "passed", "attachments": [{"name": "状态说明", "source": "0dd470b8-3fb6-4346-abfb-79fb7354e9ff-attachment.txt", "type": "text/plain"}], "start": 1761729623842, "stop": 1761729623842}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "attachments": [{"name": "执行SQL", "source": "802ac832-457f-4396-a0c6-ae14dca75818-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "0cfd35e1-a9cf-46ab-94d1-91f1fa368c32-attachment.txt", "type": "text/plain"}], "start": 1761729625899, "stop": 1761729626001}], "attachments": [{"name": "查询条件", "source": "c91d9cc0-cd08-48bc-8124-39772f9c2b7b-attachment.txt", "type": "text/plain"}], "start": 1761729625899, "stop": 1761729626001}, {"name": "轮询中（已等待2.3秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "3f76e144-9be0-4889-9041-cd69426af5c9-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "137ad104-febd-4829-8f73-a55468df4b26-attachment.txt", "type": "text/plain"}], "start": 1761729626001, "stop": 1761729626002}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "4a27480a-7dea-41a5-b940-fe2618bc40ba-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "37b3e6b4-d8cf-403d-a4cc-f353f3813291-attachment.txt", "type": "text/plain"}], "start": 1761729626002, "stop": 1761729626003}, {"name": "数据首次稳定", "status": "passed", "attachments": [{"name": "状态说明", "source": "2116ad46-ebbd-48e4-963b-fabc22e1d5a9-attachment.txt", "type": "text/plain"}], "start": 1761729626003, "stop": 1761729626003}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "attachments": [{"name": "执行SQL", "source": "80dd951e-4513-47da-a028-1a77cc57628c-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "a65531ee-002b-4c4e-a3ed-7700864c40e9-attachment.txt", "type": "text/plain"}], "start": 1761729628058, "stop": 1761729628111}], "attachments": [{"name": "查询条件", "source": "a682d0dd-678b-4b31-a861-102baecde8d3-attachment.txt", "type": "text/plain"}], "start": 1761729628057, "stop": 1761729628111}, {"name": "轮询中（已等待4.4秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "c9969551-60f0-4729-b4f5-aae19d44ba38-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "c20007bf-3722-4c89-a7cc-bdc8f4b8f092-attachment.txt", "type": "text/plain"}], "start": 1761729628111, "stop": 1761729628111}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "1fc1e388-7fee-45d5-9003-5f39290e3f25-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "847da593-3a44-49ed-9379-61754c85092f-attachment.txt", "type": "text/plain"}], "start": 1761729628111, "stop": 1761729628112}, {"name": "数据稳定达标", "status": "passed", "attachments": [{"name": "结果说明", "source": "85f64b55-a03a-4e75-87ad-996527d72587-attachment.txt", "type": "text/plain"}], "start": 1761729628112, "stop": 1761729628112}, {"name": "数据库查询结果（最终稳定结果）", "status": "passed", "attachments": [{"name": "查询结果（共1条，显示前50条）", "source": "dfc309e0-9d23-451a-9539-417fbaac0643-attachment.json", "type": "application/json"}, {"name": "执行SQL", "source": "5631239c-989e-4bf8-b243-1efa7765f30f-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "5d3d3310-ce1f-45fd-8c55-77be649f1af0-attachment.txt", "type": "text/plain"}, {"name": "查询时间窗口", "source": "7e2de67a-cdfb-4564-8ee1-e633e733bb57-attachment.txt", "type": "text/plain"}], "start": 1761729628112, "stop": 1761729628114}], "start": 1761729623720, "stop": 1761729628114}], "start": 1761729623720, "stop": 1761729628114}, {"name": "2. 转换Redis数据为可比较格式", "status": "passed", "start": 1761729628114, "stop": 1761729628114}, {"name": "3. 比较Redis与数据库数据", "status": "failed", "statusDetails": {"message": "AssertionError: Failed: 数据列表不匹配（字段 size 精度不匹配）\n", "trace": "  File \"D:\\pycharm_test\\lingkuanMT5_1029\\test_cloudTrader\\test_cloudOrder_open_level.py\", line 889, in test_dbquery_redis\n    self.assert_data_lists_equal(\n  File \"D:\\pycharm_test\\lingkuanMT5_1029\\commons\\api_base.py\", line 1312, in assert_data_lists_equal\n    raise e\n  File \"D:\\pycharm_test\\lingkuanMT5_1029\\commons\\api_base.py\", line 1304, in assert_data_lists_equal\n    assert abs(actual_val - expected_val) <= tolerance, \\\n"}, "steps": [{"name": "断言数据列表相等", "status": "passed", "attachments": [{"name": "比较维度", "source": "4d6f8f62-4d5c-4708-b4e8-a40238683993-attachment.txt", "type": "text/plain"}, {"name": "精度设置", "source": "fa9fb69f-c19d-488e-94ad-f3053c9c3a74-attachment.txt", "type": "text/plain"}, {"name": "实际列表", "source": "4921a070-a42a-4846-82b6-f3e3c1b85e65-attachment.json", "type": "application/json"}, {"name": "预期列表", "source": "d087ab65-4379-4fd7-bc8b-1bbf166ce76b-attachment.json", "type": "application/json"}], "start": 1761729628114, "stop": 1761729628116}, {"name": "数据列表断言失败", "status": "passed", "attachments": [{"name": "错误详情", "source": "c6d218e6-f957-40d4-b8da-0d5901ba6c75-attachment.txt", "type": "text/plain"}], "start": 1761729628116, "stop": 1761729628116}], "start": 1761729628114, "stop": 1761729628116}], "attachments": [{"name": "log", "source": "f2e57ddc-5170-4362-9b6d-2b66c6b2364a-attachment.txt", "type": "text/plain"}], "start": 1761729623720, "stop": 1761729628116, "uuid": "fd318c8e-b415-40f4-8185-de471bba249c", "historyId": "caafd6ad562a55b192d9f89f619e9f3d", "testCaseId": "caafd6ad562a55b192d9f89f619e9f3d", "fullName": "test_cloudTrader.test_cloudOrder_open_level.TestMT5cloudTrader_level#test_dbquery_redis", "labels": [{"name": "feature", "value": "云策略-策略账号交易下单-漏单场景"}, {"name": "story", "value": "场景2：交易下单-云策略复制下单-漏平"}, {"name": "parentSuite", "value": "test_cloudTrader"}, {"name": "suite", "value": "test_cloudOrder_open_level"}, {"name": "subSuite", "value": "TestMT5cloudTrader_openandlevel"}, {"name": "host", "value": "DESKTOP-4S9CU1E"}, {"name": "thread", "value": "80940-MainThread"}, {"name": "framework", "value": "pytest"}, {"name": "language", "value": "cpython3"}, {"name": "package", "value": "test_cloudTrader.test_cloudOrder_open_level"}]}