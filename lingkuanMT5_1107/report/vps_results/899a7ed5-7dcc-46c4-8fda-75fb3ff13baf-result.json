{"name": "数据库校验-交易平仓-跟单指令及订单详情数据检查-有2个订单", "status": "failed", "statusDetails": {"message": "Failed: 校验失败: 平仓的订单数量功能正确，应该有2个平仓订单\n\n实际: 1\n操作: ==\n预期: 2", "trace": "self = <lingkuanMT5_1107.test_vps.test_vps_masOrderClose.TestVPSMasOrderclose.TestVPStradingOrders6 object at 0x000002E3BDBC7040>\nclass_random_str = 'egtx8859'\nvar_manager = <lingkuanMT5_1107.commons.variable_manager.VariableManager object at 0x000002E3BDAD1760>\ndb_transaction = <DBUtils.PooledDB.PooledDedicatedDBConnection object at 0x000002E3BDDB0280>\n\n    @allure.title(\"数据库校验-交易平仓-跟单指令及订单详情数据检查-有2个订单\")\n    def test_dbquery_addsalve_orderSendclose(self, class_random_str, var_manager, db_transaction):\n        with allure.step(\"1. 获取订单详情表账号数据\"):\n            MT5vps_user_accounts_1 = var_manager.get_variable(\"MT5vps_user_accounts_1\")\n            MT5vps_addslave_id = var_manager.get_variable(\"MT5vps_addslave_id\")\n            sql = f\"\"\"\n               SELECT\n                   fod.size,\n                   fod.close_no,\n                   fod.magical,\n                   fod.open_price,\n                   fod.symbol,\n                   fod.order_no,\n                   fod.comment,\n                   fod.close_time,\n                   foi.true_total_lots,\n                   foi.order_no,\n                   foi.operation_type,\n                   foi.create_time,\n                   foi.status,\n                   foi.min_lot_size,\n                   foi.max_lot_size,\n                   foi.total_lots,\n                   foi.master_order,\n                   foi.total_orders\n               FROM\n                   follow_order_detail fod\n               INNER JOIN\n                   follow_order_instruct foi\n               ON\n                   foi.order_no = fod.close_no COLLATE utf8mb4_0900_ai_ci\n               WHERE foi.operation_type = %s\n                   AND fod.account = %s\n                   AND fod.comment = %s\n                   AND fod.trader_id = %s\n                   \"\"\"\n            params = (\n                '1',\n                MT5vps_user_accounts_1,\n                class_random_str,\n                MT5vps_addslave_id,\n            )\n    \n            # 调用轮询等待方法（带时间范围过滤）\n            db_data = self.query_database_with_time(\n                db_transaction=db_transaction,\n                sql=sql,\n                params=params,\n                time_field=\"foi.create_time\"\n            )\n        with allure.step(\"2. 数据校验\"):\n>           self.verify_data(\n                actual_value=len(db_data),\n                expected_value=2,\n                op=CompareOp.EQ,\n                message=f\"平仓的订单数量功能正确，应该有2个平仓订单\",\n                attachment_name=\"订单数量详情\"\n            )\n\ntest_vps\\test_vps_masOrderClose.py:1961: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nself = <lingkuanMT5_1107.test_vps.test_vps_masOrderClose.TestVPSMasOrderclose.TestVPStradingOrders6 object at 0x000002E3BDBC7040>\nactual_value = 1, expected_value = 2, op = <CompareOp.EQ: '=='>\nmessage = '平仓的订单数量功能正确，应该有2个平仓订单', attachment_name = '订单数量详情'\nattachment_type = 'text/plain', use_isclose = True, rel_tol = 1e-09, abs_tol = 0\n\n    def verify_data(\n            self,\n            actual_value,\n            expected_value,\n            op: CompareOp,\n            message: str,\n            attachment_name: str,\n            attachment_type=\"text/plain\",\n            use_isclose=True,  # 新增参数：是否启用math.isclose容错（默认启用）\n            rel_tol=1e-9,  # 相对容差（仅当use_isclose=True时生效）\n            abs_tol=0  # 绝对容差（仅当use_isclose=True时生效）\n    ):\n        \"\"\"\n        通用数据校验函数，支持浮点容错比较\n        :param actual_value: 实际值\n        :param expected_value: 预期值\n        :param op: 比较操作，CompareOp 枚举\n        :param message: 校验失败时的提示信息\n        :param attachment_name: Allure 附件名称\n        :param attachment_type: Allure 附件类型，默认文本\n        :param use_isclose: 是否使用math.isclose进行浮点容错比较\n        :param rel_tol: 相对容差（默认1e-9）\n        :param abs_tol: 绝对容差（默认0.0）\n        其他参数同前\n        \"\"\"\n        with allure.step(f\"校验: {message}\"):\n            result = False\n            try:\n                # 处理浮点容错比较（仅对EQ/NE操作生效）\n                if use_isclose and op in (CompareOp.EQ, CompareOp.NE):\n                    if not (isinstance(actual_value, (int, float)) and\n                            isinstance(expected_value, (int, float))):\n                        # 非数字类型自动禁用isclose，避免报错\n                        use_isclose = False\n                        logging.warning(f\"自动禁用isclose：非数字类型比较（实际值类型：{type(actual_value)}）\")\n    \n                    # 计算isclose结果\n                    is_close = math.isclose(\n                        actual_value,\n                        expected_value,\n                        rel_tol=rel_tol,\n                        abs_tol=abs_tol\n                    )\n                    # 根据操作类型取反\n                    result = is_close if op == CompareOp.EQ else not is_close\n    \n                # 普通比较逻辑\n                else:\n                    if op == CompareOp.EQ:\n                        result = actual_value == expected_value\n                    elif op == CompareOp.NE:\n                        result = actual_value != expected_value\n                    elif op == CompareOp.GT:\n                        result = actual_value > expected_value\n                    elif op == CompareOp.LT:\n                        result = actual_value < expected_value\n                    elif op == CompareOp.GE:\n                        result = actual_value >= expected_value\n                    elif op == CompareOp.LE:\n                        result = actual_value <= expected_value\n                    elif op == CompareOp.IN:\n                        result = actual_value in expected_value\n                    elif op == CompareOp.NOT_IN:\n                        result = actual_value not in expected_value\n    \n            except TypeError as e:\n                pytest.fail(\n                    f\"校验类型错误: {str(e)}\\n实际值类型: {type(actual_value)}, 预期值类型: {type(expected_value)}\")\n    \n            # 生成详细提示信息（包含容差参数）\n            detail_msg = (\n                f\"\\n实际: {actual_value}\\n\"\n                f\"操作: {op.value}\\n\"\n                f\"预期: {expected_value}\\n\"\n            )\n    \n            # 添加allure.attach，将信息写入报告\n            allure.attach(\n                detail_msg,  # 附件内容\n                name=attachment_name,  # 附件名称（来自参数）\n                attachment_type=attachment_type  # 附件类型\n            )\n    \n            if not result:\n>               pytest.fail(f\"校验失败: {message}\\n{detail_msg}\")\nE               Failed: 校验失败: 平仓的订单数量功能正确，应该有2个平仓订单\nE               \nE               实际: 1\nE               操作: ==\nE               预期: 2\n\ncommons\\api_base.py:1459: Failed"}, "description": "\n    ### 测试说明\n    - 前置条件：有vps策略和vps跟单\n      1. 进行开仓，手数范围：0.1-1，总订单数量4\n      2. 进行平仓-订单数量2\n      3. 校验平仓的订单数，应该等于2\n      4. 进行平仓-订单数量2\n      5. 校验平仓的订单数,等于4\n    - 预期结果：平仓的订单数量功能正确\n    ", "steps": [{"name": "1. 获取订单详情表账号数据", "status": "passed", "steps": [{"name": "轮询等待数据稳定（超时: 30秒，稳定期: 2秒）", "status": "passed", "steps": [{"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "start": 1762928863338, "stop": 1762928863389}], "attachments": [{"name": "查询条件", "source": "8481ba80-27f7-4a54-a552-7a06a3d095c0-attachment.txt", "type": "text/plain"}], "start": 1762928863337, "stop": 1762928863390}, {"name": "轮询中（已等待0.1秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "d9723907-cbce-4d93-8854-deb2387b3f92-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "861f9ebd-d5db-4ddd-a783-8bf2f8725908-attachment.txt", "type": "text/plain"}], "start": 1762928863390, "stop": 1762928863391}, {"name": "查询结果为空", "status": "passed", "attachments": [{"name": "状态说明", "source": "1b26e555-f479-4379-a52d-2422b91d42c3-attachment.txt", "type": "text/plain"}], "start": 1762928863391, "stop": 1762928863391}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "start": 1762928865438, "stop": 1762928865492}], "attachments": [{"name": "查询条件", "source": "c1f3cb92-2a1d-4390-8ed9-36aabd3dc7d7-attachment.txt", "type": "text/plain"}], "start": 1762928865438, "stop": 1762928865493}, {"name": "轮询中（已等待2.2秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "6ee26340-2cae-4d04-801d-2dc2bfc04469-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "ead9496e-4496-4185-808c-62c7567268cc-attachment.txt", "type": "text/plain"}], "start": 1762928865493, "stop": 1762928865494}, {"name": "查询结果为空", "status": "passed", "attachments": [{"name": "状态说明", "source": "bdb0f286-ecdd-437e-aebb-6144828a0ae3-attachment.txt", "type": "text/plain"}], "start": 1762928865494, "stop": 1762928865494}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "start": 1762928867555, "stop": 1762928867607}], "attachments": [{"name": "查询条件", "source": "3f07e7c0-1569-4a5d-8f0b-63e42ef78555-attachment.txt", "type": "text/plain"}], "start": 1762928867554, "stop": 1762928867607}, {"name": "轮询中（已等待4.3秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "a308623d-94cb-421c-bfa4-fbed0d8a2d80-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "1ab26050-22f0-4f69-b63d-c5e9012ce789-attachment.txt", "type": "text/plain"}], "start": 1762928867607, "stop": 1762928867608}, {"name": "查询结果为空", "status": "passed", "attachments": [{"name": "状态说明", "source": "eb343917-5cda-4fbf-bcdc-e496963a0177-attachment.txt", "type": "text/plain"}], "start": 1762928867608, "stop": 1762928867608}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "start": 1762928869667, "stop": 1762928869719}], "attachments": [{"name": "查询条件", "source": "99b29562-b0b1-44ad-9f7f-219df8b3d95f-attachment.txt", "type": "text/plain"}], "start": 1762928869666, "stop": 1762928869719}, {"name": "轮询中（已等待6.4秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "b8232f91-455b-4616-9265-cefe7f195930-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "efce2673-b547-4c8a-bf51-193ce9f9542a-attachment.txt", "type": "text/plain"}], "start": 1762928869719, "stop": 1762928869720}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "90a637c2-4b57-4618-bcf4-ad91fc8b785b-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "afc8bed1-4743-408d-bfde-98927634326b-attachment.txt", "type": "text/plain"}], "start": 1762928869720, "stop": 1762928869720}, {"name": "数据发生变化", "status": "passed", "attachments": [{"name": "状态说明", "source": "07ba0d7b-e173-4852-9af8-5df410dc37e1-attachment.txt", "type": "text/plain"}], "start": 1762928869720, "stop": 1762928869721}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "start": 1762928871778, "stop": 1762928871837}], "attachments": [{"name": "查询条件", "source": "49aa25e0-1cf8-4e6c-9f2d-8e7a1212ac37-attachment.txt", "type": "text/plain"}], "start": 1762928871777, "stop": 1762928871837}, {"name": "轮询中（已等待8.5秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "1f409b1d-28c4-47cc-bdf1-a016d4c36915-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "9bc5f422-ff2f-474f-8d6d-87c4e503ed22-attachment.txt", "type": "text/plain"}], "start": 1762928871837, "stop": 1762928871838}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "154e1101-3000-43ac-baca-db12058ae3a6-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "784b33bb-fa06-4b85-94f1-818ae80b1481-attachment.txt", "type": "text/plain"}], "start": 1762928871838, "stop": 1762928871838}, {"name": "数据发生变化", "status": "passed", "attachments": [{"name": "状态说明", "source": "939edec1-251d-4d43-a4c3-a73a8a583dc5-attachment.txt", "type": "text/plain"}], "start": 1762928871838, "stop": 1762928871838}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "start": 1762928873894, "stop": 1762928873948}], "attachments": [{"name": "查询条件", "source": "d963531b-2bd9-47b0-96c8-1720264ad35e-attachment.txt", "type": "text/plain"}], "start": 1762928873894, "stop": 1762928873948}, {"name": "轮询中（已等待10.7秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "7a7784cb-1ca3-4a23-8a8c-a053eb3cb7fe-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "01f36225-94b2-4476-a478-be23cdd69db9-attachment.txt", "type": "text/plain"}], "start": 1762928873948, "stop": 1762928873949}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "9a5835e7-48f0-4aff-8d6c-d7adf8f50c8d-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "a8fdc6d1-2705-4abf-a7b4-e720744e69f5-attachment.txt", "type": "text/plain"}], "start": 1762928873949, "stop": 1762928873950}, {"name": "数据首次稳定", "status": "passed", "attachments": [{"name": "状态说明", "source": "2933d851-f5a7-41fd-832e-436afac321f3-attachment.txt", "type": "text/plain"}], "start": 1762928873950, "stop": 1762928873950}, {"name": "执行单次数据库查询", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "start": 1762928876008, "stop": 1762928876061}], "attachments": [{"name": "查询条件", "source": "c8497689-ed37-4673-bde4-c30528e14f9c-attachment.txt", "type": "text/plain"}], "start": 1762928876007, "stop": 1762928876061}, {"name": "轮询中（已等待12.8秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "7de207a6-6a8b-4aeb-a571-62fa45896e10-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "5494425a-256e-459b-9e12-36b9a6724782-attachment.txt", "type": "text/plain"}], "start": 1762928876061, "stop": 1762928876062}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "816ecce1-ba43-41c3-95e0-6e56ab384f78-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "1dea0e7a-4c89-4707-9bd0-360e1782e483-attachment.txt", "type": "text/plain"}], "start": 1762928876062, "stop": 1762928876062}, {"name": "数据稳定达标", "status": "passed", "attachments": [{"name": "结果说明", "source": "4f24e725-2a17-4a3e-9c72-8a10ed107b15-attachment.txt", "type": "text/plain"}], "start": 1762928876063, "stop": 1762928876063}, {"name": "数据库查询结果（最终稳定结果）", "status": "passed", "attachments": [{"name": "查询结果（共1条，显示前50条）", "source": "8a97ad10-f3e5-47dc-9c85-f3ed42114344-attachment.json", "type": "application/json"}, {"name": "执行SQL", "source": "961588c5-2024-4a3d-9329-3b6f6566fe95-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "f34cc99d-df38-42f6-8352-f6348a76284b-attachment.txt", "type": "text/plain"}, {"name": "查询时间窗口", "source": "4867e24d-602a-4a19-99e1-d220a6f001fa-attachment.txt", "type": "text/plain"}], "start": 1762928876063, "stop": 1762928876064}], "start": 1762928863292, "stop": 1762928876064}], "start": 1762928863292, "stop": 1762928876064}, {"name": "2. 数据校验", "status": "failed", "statusDetails": {"message": "Failed: 校验失败: 平仓的订单数量功能正确，应该有2个平仓订单\n\n实际: 1\n操作: ==\n预期: 2\n\n", "trace": "  File \"D:\\pycharm_test\\lingkuanMT5_1107\\test_vps\\test_vps_masOrderClose.py\", line 1961, in test_dbquery_addsalve_orderSendclose\n    self.verify_data(\n  File \"D:\\pycharm_test\\lingkuanMT5_1107\\commons\\api_base.py\", line 1459, in verify_data\n    pytest.fail(f\"校验失败: {message}\\n{detail_msg}\")\n  File \"D:\\pycharm_test\\Community\\lib\\site-packages\\_pytest\\outcomes.py\", line 198, in fail\n    raise Failed(msg=reason, pytrace=pytrace)\n"}, "steps": [{"name": "校验: 平仓的订单数量功能正确，应该有2个平仓订单", "status": "failed", "statusDetails": {"message": "Failed: 校验失败: 平仓的订单数量功能正确，应该有2个平仓订单\n\n实际: 1\n操作: ==\n预期: 2\n\n", "trace": "  File \"D:\\pycharm_test\\lingkuanMT5_1107\\commons\\api_base.py\", line 1459, in verify_data\n    pytest.fail(f\"校验失败: {message}\\n{detail_msg}\")\n  File \"D:\\pycharm_test\\Community\\lib\\site-packages\\_pytest\\outcomes.py\", line 198, in fail\n    raise Failed(msg=reason, pytrace=pytrace)\n"}, "attachments": [{"name": "订单数量详情", "source": "501a85b7-f923-460a-8146-6b36bc97f183-attachment.attach", "type": "text/plain"}], "start": 1762928876064, "stop": 1762928876065}], "start": 1762928876064, "stop": 1762928876065}], "attachments": [{"name": "log", "source": "f72c487d-2e36-47c2-bd3f-5d30abfa28b8-attachment.txt", "type": "text/plain"}], "start": 1762928863292, "stop": 1762928876065, "uuid": "cfcb682d-d7f7-4e0b-bd2f-3e9a11962abb", "historyId": "20db9a6d21e7bc1d6eee966f7af3241e", "testCaseId": "20db9a6d21e7bc1d6eee966f7af3241e", "fullName": "test_vps.test_vps_masOrderClose.TestVPStradingOrders6#test_dbquery_addsalve_orderSendclose", "labels": [{"name": "feature", "value": "VPS策略账号交易下单-平仓的功能校验"}, {"name": "story", "value": "场景6：平仓的订单数量功能校验-4"}, {"name": "tag", "value": "@pytest.mark.usefixtures('class_random_str')"}, {"name": "tag", "value": "flaky(reruns=0, reruns_delay=0)"}, {"name": "parentSuite", "value": "test_vps"}, {"name": "suite", "value": "test_vps_masOrderClose"}, {"name": "subSuite", "value": "TestVPSMasOrderclose"}, {"name": "host", "value": "DESKTOP-4S9CU1E"}, {"name": "thread", "value": "64996-MainThread"}, {"name": "framework", "value": "pytest"}, {"name": "language", "value": "cpython3"}, {"name": "package", "value": "test_vps.test_vps_masOrderClose"}]}