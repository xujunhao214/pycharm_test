{"name": "数据库校验-策略开仓-主指令及订单详情数据检查", "status": "broken", "statusDetails": {"message": "UnboundLocalError: local variable 'totalSzie' referenced before assignment", "trace": "self = <lingkuan_MT5.test_vps.test_vps_ordersend.TestVPSOrdersend.TestVPSOrderSend2 object at 0x000002A7D2CD06D0>\nvar_manager = <lingkuan_MT5.commons.variable_manager.VariableManager object at 0x000002A7D2F5E8E0>\ndb_transaction = <pymysql.connections.Connection object at 0x000002A7D2993D90>\n\n    @allure.title(\"数据库校验-策略开仓-主指令及订单详情数据检查\")\n    def test_dbquery_orderSend(self, var_manager, db_transaction):\n        with allure.step(\"1. 获取订单详情表账号数据\"):\n            new_user = var_manager.get_variable(\"new_user\")\n            sql = f\"\"\"\n                SELECT\n                    fod.size,\n                    fod.comment,\n                    fod.send_no,\n                    fod.magical,\n                    fod.open_price,\n                    fod.symbol,\n                    fod.order_no,\n                    foi.true_total_lots,\n                    foi.order_no,\n                    foi.operation_type,\n                    foi.create_time,\n                    foi.status,\n                    foi.min_lot_size,\n                    foi.max_lot_size,\n                    foi.total_lots,\n                    foi.total_orders\n                FROM\n                    follow_order_detail fod\n                INNER JOIN\n                    follow_order_instruct foi\n                ON\n                    foi.order_no = fod.send_no COLLATE utf8mb4_0900_ai_ci\n                WHERE foi.operation_type = %s\n                    AND fod.account = %s\n                    AND fod.comment = %s\n                    \"\"\"\n            params = (\n                '0',\n                new_user[\"account\"],\n                \"changjing2\"\n            )\n    \n            # 调用轮询等待方法（带时间范围过滤）\n            db_data = self.query_database_with_time_with_timezone(\n                db_transaction=db_transaction,\n                sql=sql,\n                params=params,\n                time_field=\"fod.open_time\"\n            )\n        with allure.step(\"2. 数据校验\"):\n            trader_ordersend = var_manager.get_variable(\"trader_ordersend\")\n            if not db_data:\n                pytest.fail(\"数据库查询结果为空，无法提取数据\")\n    \n            with allure.step(\"验证订单状态\"):\n                status = db_data[0][\"status\"]\n                self.verify_data(\n                    actual_value=status,\n                    expected_value=(0, 1, 3),\n                    op=CompareOp.IN,\n                    message=\"订单状态应为0或1或3\",\n                    attachment_name=\"订单状态详情\"\n                )\n                logging.info(f\"订单状态验证通过: {status}\")\n    \n            with allure.step(\"验证手数范围-开始手数\"):\n                max_lot_size = db_data[0][\"max_lot_size\"]\n                self.verify_data(\n                    actual_value=float(max_lot_size),\n                    expected_value=float(0.01),\n                    op=CompareOp.EQ,\n                    message=\"开始手数应符合预期\",\n                    attachment_name=\"开始手数详情\"\n                )\n                logging.info(f\"开始手数验证通过: {trader_ordersend['startSize']}\")\n    \n            with allure.step(\"验证手数范围-结束手数\"):\n                min_lot_size = db_data[0][\"min_lot_size\"]\n                self.verify_data(\n                    actual_value=float(min_lot_size),\n                    expected_value=float(0.01),\n                    op=CompareOp.EQ,\n                    message=\"结束手数应符合预期\",\n                    attachment_name=\"结束手数详情\"\n                )\n                logging.info(f\"结束手数验证通过: {trader_ordersend['endSize']}\")\n    \n            with allure.step(\"验证指令总手数\"):\n                total_lots = db_data[0][\"total_lots\"]\n                self.verify_data(\n                    actual_value=float(total_lots),\n                    expected_value=float(0.01),\n                    op=CompareOp.EQ,\n                    message=\"指令总手数应符合预期\",\n                    attachment_name=\"指令总手数详情\"\n                )\n                logging.info(f\"指令总手数验证通过: {total_lots}\")\n    \n            with allure.step(\"验证详情总手数\"):\n                size = [record[\"size\"] for record in db_data]\n                total = sum(size)\n                # 关键优化：四舍五入保留一位小数\n                total = round(float(total), 1)\n>               totalSzie = round(float(totalSzie), 1)\nE               UnboundLocalError: local variable 'totalSzie' referenced before assignment\n\ntest_vps\\test_vps_ordersend.py:692: UnboundLocalError"}, "description": "\n    ### 测试说明\n    - 前置条件：有云策略和云跟单\n      1. 进行开仓，手数范围0.01-0.01，总手数0.01\n      2. 校验账号的数据是否正确\n      3. 进行平仓\n      4. 校验账号的数据是否正确\n    - 预期结果：账号的数据正确\n    ", "steps": [{"name": "1. 获取订单详情表账号数据", "status": "passed", "steps": [{"name": "轮询等待数据稳定（时区+05:00，超时30秒）", "status": "passed", "steps": [{"name": "带时区转换查询（目标时区: +05:00）", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "attachments": [{"name": "执行SQL", "source": "f62c21ed-177c-443c-bf66-3e503a629c9b-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "26a68ed6-c57d-4280-87fc-5ea88f3481d6-attachment.txt", "type": "text/plain"}], "start": 1761619789781, "stop": 1761619789831}], "attachments": [{"name": "时区处理", "source": "47b1d186-cf96-44ee-96f0-c19b38dc0bed-attachment.txt", "type": "text/plain"}, {"name": "查询条件", "source": "485b2d72-7175-4863-8029-13895e99b2f5-attachment.txt", "type": "text/plain"}], "start": 1761619789780, "stop": 1761619789831}, {"name": "轮询中（已等待0.1秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "f95a91ae-e570-4abe-b9d7-ced6ad46038d-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "410fb168-b0e2-41dc-b0b5-5c0a1610e60b-attachment.txt", "type": "text/plain"}], "start": 1761619789831, "stop": 1761619789832}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "判断结果", "source": "c971e8a5-4d1b-465a-880a-08ae59dba554-attachment.txt", "type": "text/plain"}], "start": 1761619789832, "stop": 1761619789832}, {"name": "数据发生变化", "status": "passed", "attachments": [{"name": "状态说明", "source": "db19d425-99a0-48aa-9347-9bd853e89346-attachment.txt", "type": "text/plain"}], "start": 1761619789832, "stop": 1761619789833}, {"name": "带时区转换查询（目标时区: +05:00）", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "attachments": [{"name": "执行SQL", "source": "378e907b-e00a-423c-a500-58b627e0ad98-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "2e5dd0ed-1f95-438d-936e-05ba49d28b51-attachment.txt", "type": "text/plain"}], "start": 1761619791894, "stop": 1761619791943}], "attachments": [{"name": "时区处理", "source": "111712cb-c889-474c-9763-ec6a4a573bbe-attachment.txt", "type": "text/plain"}, {"name": "查询条件", "source": "b8a66e47-60cd-44b1-9614-617d601e5639-attachment.txt", "type": "text/plain"}], "start": 1761619791893, "stop": 1761619791943}, {"name": "轮询中（已等待2.2秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "b662ef8d-aa78-4f1f-99a2-3b8333c91150-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "ecc9efbd-ccd5-49b4-8458-47d148f109b9-attachment.txt", "type": "text/plain"}], "start": 1761619791943, "stop": 1761619791944}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "bebbb9f5-090b-433d-a31e-a9da704d9bf8-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "387f9a62-181d-41bf-b81a-9d1ea67a272e-attachment.txt", "type": "text/plain"}], "start": 1761619791944, "stop": 1761619791944}, {"name": "数据首次稳定", "status": "passed", "attachments": [{"name": "状态说明", "source": "aaeee9c0-e9fe-43a0-b887-40389b79edd2-attachment.txt", "type": "text/plain"}], "start": 1761619791945, "stop": 1761619791945}, {"name": "带时区转换查询（目标时区: +05:00）", "status": "passed", "steps": [{"name": "执行数据库查询", "status": "passed", "attachments": [{"name": "执行SQL", "source": "7ae9e7f4-2612-4b92-b67d-65059265460e-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "9b3b86e6-d32b-46e7-9efb-8903ab429513-attachment.txt", "type": "text/plain"}], "start": 1761619794000, "stop": 1761619794051}], "attachments": [{"name": "时区处理", "source": "de257420-b9c6-468f-b229-709f84dbbc12-attachment.txt", "type": "text/plain"}, {"name": "查询条件", "source": "c2c2a880-167c-42b2-97ad-0683d855e884-attachment.txt", "type": "text/plain"}], "start": 1761619793999, "stop": 1761619794051}, {"name": "轮询中（已等待4.3秒）", "status": "passed", "attachments": [{"name": "当前状态", "source": "a00e7905-f0b2-4fc5-80bf-3c2bf8f5d4c1-attachment.txt", "type": "text/plain"}, {"name": "超时倒计时", "source": "3c56a710-bc52-4e10-b287-3e5d62148c71-attachment.txt", "type": "text/plain"}], "start": 1761619794052, "stop": 1761619794053}, {"name": "判断结果稳定性", "status": "passed", "attachments": [{"name": "唯一键信息", "source": "96c534fc-23de-4292-858d-27c82a3b7be3-attachment.txt", "type": "text/plain"}, {"name": "判断结果", "source": "2fcdcb02-b37a-4d74-959c-7160acbd5219-attachment.txt", "type": "text/plain"}], "start": 1761619794053, "stop": 1761619794054}, {"name": "数据稳定达标", "status": "passed", "attachments": [{"name": "结果说明", "source": "a82a01bd-43b9-48e8-86ea-4bb169da545f-attachment.txt", "type": "text/plain"}], "start": 1761619794054, "stop": 1761619794054}, {"name": "带时区查询最终结果", "status": "passed", "attachments": [{"name": "结果预览", "source": "29a0aacd-68b4-4c2a-bc10-1ded5995e41a-attachment.json", "type": "application/json"}], "start": 1761619794054, "stop": 1761619794054}], "attachments": [{"name": "执行SQL", "source": "44be4c11-80a4-4e73-beef-e2524e5c4521-attachment.txt", "type": "text/plain"}, {"name": "SQL参数", "source": "78536a97-e724-449f-a076-9543d7b8c047-attachment.txt", "type": "text/plain"}, {"name": "时区偏移量（小时）", "source": "69f10b2e-73c5-4c18-a1b1-e01830d4893c-attachment.txt", "type": "text/plain"}, {"name": "查询时间窗口", "source": "437ef8c4-273c-49d4-b8b5-73f03cb16b7e-attachment.txt", "type": "text/plain"}], "start": 1761619789733, "stop": 1761619794054}], "start": 1761619789733, "stop": 1761619794054}, {"name": "2. 数据校验", "status": "broken", "statusDetails": {"message": "UnboundLocalError: local variable 'totalSzie' referenced before assignment\n", "trace": "  File \"D:\\pycharm_test\\lingkuan_MT5\\test_vps\\test_vps_ordersend.py\", line 692, in test_dbquery_orderSend\n    totalSzie = round(float(totalSzie), 1)\n"}, "steps": [{"name": "验证订单状态", "status": "passed", "steps": [{"name": "校验: 订单状态应为0或1或3", "status": "passed", "attachments": [{"name": "订单状态详情", "source": "b271c40d-179a-4ed4-b8db-73c5155e9451-attachment.attach", "type": "text/plain"}], "start": 1761619794054, "stop": 1761619794055}], "start": 1761619794054, "stop": 1761619794055}, {"name": "验证手数范围-开始手数", "status": "passed", "steps": [{"name": "校验: 开始手数应符合预期", "status": "passed", "attachments": [{"name": "开始手数详情", "source": "68fcc776-1654-455c-9f31-f9ab1597b3ca-attachment.attach", "type": "text/plain"}], "start": 1761619794055, "stop": 1761619794055}], "start": 1761619794055, "stop": 1761619794055}, {"name": "验证手数范围-结束手数", "status": "passed", "steps": [{"name": "校验: 结束手数应符合预期", "status": "passed", "attachments": [{"name": "结束手数详情", "source": "c4daaedd-1b1e-45f0-b104-88cdf1d84bf0-attachment.attach", "type": "text/plain"}], "start": 1761619794055, "stop": 1761619794056}], "start": 1761619794055, "stop": 1761619794056}, {"name": "验证指令总手数", "status": "passed", "steps": [{"name": "校验: 指令总手数应符合预期", "status": "passed", "attachments": [{"name": "指令总手数详情", "source": "69555fa8-8624-450f-ac0d-4141550ab9bf-attachment.attach", "type": "text/plain"}], "start": 1761619794056, "stop": 1761619794056}], "start": 1761619794056, "stop": 1761619794056}, {"name": "验证详情总手数", "status": "broken", "statusDetails": {"message": "UnboundLocalError: local variable 'totalSzie' referenced before assignment\n", "trace": "  File \"D:\\pycharm_test\\lingkuan_MT5\\test_vps\\test_vps_ordersend.py\", line 692, in test_dbquery_orderSend\n    totalSzie = round(float(totalSzie), 1)\n"}, "start": 1761619794056, "stop": 1761619794056}], "start": 1761619794054, "stop": 1761619794056}], "attachments": [{"name": "log", "source": "01afcd7e-8f71-4560-a4b4-99e216cce82c-attachment.txt", "type": "text/plain"}], "start": 1761619789733, "stop": 1761619794056, "uuid": "2a2a265b-8225-4b0e-8a45-8222ba87df57", "historyId": "69f4b98e51e0aa128b684d7dfe769aac", "testCaseId": "69f4b98e51e0aa128b684d7dfe769aac", "fullName": "test_vps.test_vps_ordersend.TestVPSOrderSend2#test_dbquery_orderSend", "labels": [{"name": "feature", "value": "VPS策略下单-开仓的场景校验"}, {"name": "story", "value": "场景2：复制下单-手数范围0.01-0.01，总手数0.01"}, {"name": "parentSuite", "value": "test_vps"}, {"name": "suite", "value": "test_vps_ordersend"}, {"name": "subSuite", "value": "TestVPSOrdersend"}, {"name": "host", "value": "DESKTOP-4S9CU1E"}, {"name": "thread", "value": "56380-MainThread"}, {"name": "framework", "value": "pytest"}, {"name": "language", "value": "cpython3"}, {"name": "package", "value": "test_vps.test_vps_ordersend"}]}